{"version":3,"file":"Vouchers-3ad6bb52.js","sources":["../../src/VoucherView.html","../../src/Vouchers.html"],"sourcesContent":["<script>\n    import { onMount, afterUpdate } from 'svelte'\n    import Toolbar from './UI/UIToolbar.html'\n    import TextField from './UI/UITextField.html'\n    import ModalView from './UI/UIModalView.html'\n    import Segmented from './UI/UISegmented.html';\n    import Loading from './UI/UILoading.html'\n    import { writable } from 'svelte/store';\n\n        \n    import { session, api, alert, accounts, modal, apply, fetch, customers, pop_modal, s3 } from './CTStore.js';\n    export let voucher = { code: \"\", discount: 0 };\n    let loading = false;\n    const mode = writable(\"discount\");\n\n    mode.subscribe(value => {\n        switch (value) {\n            case 'discount':\n                voucher = { code: voucher.code, discount: 0 }\n                break;\n            case 'delivery':\n                voucher = { code: voucher.code, delivery: 0, min: 0 }\n                break;\n        } \n    });\n    let style = { body: 'screen-height', content: 'overflow-y-scroll scrolling-touch' }\n    let tool_style = { container: \"justify-end\" }, field_style = { container: 'w-1/2 m-2' };\n    let tools = [{ name: \"Close\", icon: \"close-circle\", function: \"pop_modal\" },\n    { name: \"Save\", icon: \"checkmark-circle\", function: \"save\" }]\n    function selected(e) {\n        if (e.detail.function == 'pop_modal') {\n            pop_modal()\n        }\n        if (e.detail.function == 'save') {\n            loading = true;\n            fetch(api(`/vouchers`), voucher).then(r => { $apply = { voucher: r }; pop_modal(); });\n        }\n    }\n    function toggleMin(){\n      var v = {...voucher};\n      v.min = voucher.min!=undefined ? undefined : 0;\n      voucher = {...v};\n      console.log(voucher);\n    }\n</script>\n<ModalView style=\"{style}\">\n    <div slot=\"loader\">\n        {#if loading}\n  <Loading>\n    <div slot=\"message\">\n      One Moment Please..\n    </div>\n  </Loading>\n    {/if}\n  </div>\n  <div slot=\"title\" class=\"font-semibold text-xl text-gray-600 pb-3\">\n    { voucher._id ? 'Edit Voucher' : 'Create Voucher'}\n  </div>\n  <div slot=\"content\">\n    <div class=\"flex mb-2\">\n        <TextField style=\"{field_style}\" label=\"Code\" placeholder=\"Enter a voucher code\" bind:value=\"{voucher.code}\" />\n    </div>\n    <Segmented style=\"{field_style}\"\n        label=\"Type\"\n        segments=\"{[{ name : 'Discount', value : 'discount'}, { name : 'Delivery', value : 'delivery'}]}\"\n        bind:value=\"{$mode}\" />\n    \n        {#if $mode==\"discount\"}\n        <div class=\"mb-2\">\n        <TextField style=\"{field_style}\" label=\"Discount (%)\" placeholder=\"e.g : 10\" bind:value=\"{voucher.discount}\" />\n        <button class=\"ml-3 text-sm text-gray-600\" on:click=\"{toggleMin}\">\n          <i class=\"icon ion-md-{ voucher.min!=undefined ? 'checkbox' : 'square' }-outline pr-2\"></i> Requires Min. Spending\n        </button>\n        {#if voucher.min!=undefined}\n        <TextField style=\"{field_style}\" label=\"Min. Spending (RM)\" placeholder=\"e.g : 0\" bind:value=\"{voucher.min}\" />\n        {/if}\n        </div>\n        {:else if $mode==\"delivery\"}\n        <div class=\"flex mb-2\">\n          <TextField style=\"{field_style}\" label=\"Delivery Subsidy (RM)\" placeholder=\"e.g : 0\" bind:value=\"{voucher.delivery}\" />\n          <TextField style=\"{field_style}\" label=\"Min. Spending (RM)\" placeholder=\"e.g : 0\" bind:value=\"{voucher.min}\" />\n        </div>\n        {/if}\n  </div>\n<div slot=\"toolbar\">\n    <Toolbar on:selected=\"{selected}\" tools=\"{tools}\" style=\"{tool_style}\" />\n  </div>\n</ModalView>","<script>\n    import { onMount } from 'svelte';\n    import Toolbar from './UI/UIToolbar.html';\n    import Loading from './UI/UILoading.html';\n    import UIItem from './UI/UIItem.html';\n    import VoucherView from './VoucherView.html';\n    import { session, api, alert, accounts, apply, modal, fetch } from './CTStore.js';\n    let vouchers, loading = false, redeem_count = {};\n    let style = { container: \"border-b border-gray-300\" }\n    let tools = [{ name: \"Create\", icon: \"add\", function: \"add\" }]\n    onMount(async() => {\n        vouchers = await fetch(api('/vouchers'));\n        vouchers.forEach(v => {\n            fetch(api(`/vouchers/${v._id}`)).then(c => {\n                redeem_count[v._id] = c;\n            })\n        })\n    });\n    apply.subscribe(cb => {\n        if (cb.voucher) {\n            let obj = vouchers.find(p => p._id == cb.voucher._id)\n            if (obj) {\n                vouchers = vouchers.map(p => p._id == cb.voucher._id ? cb.voucher : p)\n            } else {\n                vouchers = [...vouchers, cb.voucher]\n            }\n            $apply = {};\n        }\n    });\n    function inspect(product) {\n        $modal = [...$modal, { product, view: ProductView }]\n    }\n    function selected(e) {\n        if (e.detail.function == 'add') {\n            $modal = [...$modal, { view: VoucherView }]\n        }\n    }\n    function remove(voucher){\n        if(confirm(`Do you really want to remove this voucher (${voucher.code})?`)){\n            loading = true;\n            fetch(api(`/vouchers`), { _id : voucher._id, deletedAt : Date() }, \"PUT\").then(r => { loading = false; $apply = { voucher: {...voucher, deletedAt: Date()} } });\n        }\n    }\n</script>\n<style>\n    .sect {\n        @apply text-xl font-bold mt-3 mx-2;\n    }\n\n    table {\n        @apply w-full;\n    }\n\n    td {\n        @apply p-2;\n    }\n</style>\n<Toolbar style=\"{style}\" on:selected=\"{selected}\" tools=\"{tools}\" />\n{#if !vouchers || loading}\n<Loading type=\"h-64\">\n    <div slot=\"message\">\n      One Moment Please..\n    </div>\n  </Loading>\n{:else}\n<table class=\"my-2\">\n    <tr class=\"font-semibold text-theme text-sm text-center\">\n        <td>Voucher Code</td>\n        <td>Type</td>\n        <td>Redemptions</td>\n        <td></td>\n    </tr>\n{#each vouchers as voucher}\n    <tr class=\"text-center hover:bg-gray-200 { voucher.deletedAt ? 'opacity-25 line-through' : ''}\">\n        <td class=\"text-gray-800 text-left\">{voucher.code}</td>\n        <td>\n            {#if voucher.delivery}\n            <p>\n                Discount on delivery up to <b>RM{voucher.delivery.toFixed(2)}</b>\n            </p>\n            {/if}\n            {#if voucher.discount}\n            <p>\n                <b>{voucher.discount}%</b> discount on entire cart\n            </p>\n            {/if}\n            {#if voucher.min}\n            <p>\n                Minimum spending of <b>RM{voucher.min.toFixed(2)}</b> required\n            </p>\n            {/if}\n        </td>\n        <td>\n            {#if redeem_count[voucher._id] != undefined}\n                {redeem_count[voucher._id]}\n            {:else}\n                <i class=\"fas fa-spinner fa-spin\"></i>\n            {/if}\n        </td>\n        <td>\n            {#if !voucher.deletedAt}\n            <button class=\"p-2\" on:click=\"{ () => remove(voucher) }\">\n                <i class=\"fas fa-trash\"></i>\n            </button>\n            {/if}\n        </td>\n    </tr>\n{/each}\n</table>\n{/if}"],"names":["ctx","_id","delivery","min","discount","undefined","code","name","value","voucher","loading","mode","writable","subscribe","body","content","container","icon","function","e","detail","pop_modal","fetch","api","then","r","$apply","v","console","log","$mode","length","toFixed","deletedAt","vouchers","redeem_count","remove","confirm","Date","onMount","forEach","c","apply","cb","obj","find","p","map","$modal","view","VoucherView","product","ProductView"],"mappings":"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"}