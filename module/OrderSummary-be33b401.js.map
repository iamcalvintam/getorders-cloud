{"version":3,"file":"OrderSummary-be33b401.js","sources":["../../src/OrderSummary.html"],"sourcesContent":["<svelte:head>\n    <script src=\"https://unpkg.com/papaparse@latest/papaparse.min.js\"></script>\n</svelte:head>\n<script>\n    import { writable, derived, get } from 'svelte/store';\n    import dayjs from \"dayjs\"\n    import Segmented from './UI/UISegmented.html';\n    import Toolbar from './UI/UIToolbar.html';\n    import { api, fetch, session, modal, settings, loading, download, apply } from './CTStore.js';\n    import UIItem from './UI/UIItem.html'\n    let selected_date = dayjs();\n    let filters = writable({ type: \"paid\" }), show_vendor = '';\n    let orders = {}, page = 0, show_more = true, raw_orders = {}, products = [], vendors = [], vendor_list = { 'All Orders': [] };\n    let tools = [{ name: \"Refresh\", icon: \"refresh\", function: \"refresh\" },\n    { name: \"Export\", icon: \"cloud-download\", function: \"export\" }]\n    get_orders(0);\n    fetch(api('/vendor')).then(r => { vendors = r });\n    function selected(e) {\n        switch (e.detail.function) {\n            case \"refresh\":\n                get_orders(0)\n                break;\n            case \"export\":\n                {\n                    let orders = [];\n                    Object.keys(vendor_list).forEach(vendor => {\n                        filter(vendor).forEach(prod_id => {\n                            Object.keys(raw_orders[prod_id]).forEach(variant => {\n                                Object.keys(raw_orders[prod_id][variant]).forEach(mods => {\n                                    let item = raw_orders[prod_id][variant][mods];\n                                    let fields = {\n                                        \"Product\": prodFor(prod_id).name,\n                                        \"Variant\": variant,\n                                        \"Modifiers\": mods,\n                                        \"Quantity\": item.quantity,\n                                        \"Unit Price\": item.amount.toFixed(2),\n                                        \"Total\": (item.quantity * item.amount).toFixed(2)\n                                    }\n                                    if (vendor != 'All Orders') fields.Vendor = vendor;\n                                    orders = [...orders, fields];\n                                });\n                            });\n                        });\n                    });\n\n                    download(Papa.unparse(orders), 'orders.csv', 'text/csv;encoding:utf-8');\n                }\n                break;\n        }\n    }\n    function get_orders(pg) {\n        if (pg == 0) {\n            show_more = true;\n        }\n        page = pg;\n        $loading = true;\n        fetch(api(`/orders`), { groupBy: \"products\", order_type: $filters.type, from: selected_date.startOf('day').toJSON(), to: selected_date.endOf('day').toJSON() }, 'GET').then(data => {\n            $loading = false;\n            raw_orders = data.variants;\n            products = data.products;\n            vendor_list = vendor_list;\n        });\n    }\n    function prodFor(prod_id) {\n        return products.find(p => p.id.toString() == prod_id) || { name: \"-\" };\n    }\n    function filter(vendor) {\n        return vendor == 'All Orders' ? Object.keys(raw_orders) : Object.keys(raw_orders).filter(r => vendor_list[vendor].includes(r));\n    }\n    filters.subscribe(v => { get_orders(0) });\n    $: if (show_vendor == 'true') {\n        let list = {}\n        vendors.forEach(v => {\n            list[v.name] = v.products.map(p => p.id);\n        });\n        vendor_list = list;\n    } else {\n        vendor_list = { 'All Orders': [] };\n    }\n    function calc(sum, item) {\n        return parseFloat(sum) + parseFloat(item.unit_price) * item.quantity;\n    }\n    function message(order) {\n        let phone = order.guest.phone;\n        if (phone.startsWith('01')) phone = \"6\" + phone;\n        let url = `https://api.whatsapp.com/send?phone=${phone}&text=`, msg = \"\";\n        if (order.payment) {\n            msg = `Hey there! We *(${$settings.settings.name})* have received your order, tap here to pay now.`;\n            msg = `${msg} üëâüèª https://pay.getorders.app/?i=${order.invoice_id}\\n\\n`;\n        }\n        let txt = encodeURIComponent(msg)\n        document.location.href = `${url}${txt}`;\n    }\n    let status_colors = ['bg-gray-400', 'bg-gray-400', 'bg-gray-400', 'bg-yellow-500', 'bg-red-400', 'bg-green-500', 'bg-pink-500', 'bg-theme']\n    function changeDate(day) {\n        selected_date = selected_date.add(day, 'day');\n        get_orders(0);\n    }\n    let field_style = { container: \"p-2 flex-none\", label: \"w-32\" }\n</script>\n<style>\n    .action {\n        @apply rounded-full text-white mr-3 w-16 h-16 text-center self-center text-2xl flex-none shadow-md;\n    }\n\n    td {\n        @apply p-2;\n    }\n</style>\n<Toolbar class=\"border-b border-gray-300\" on:selected=\"{selected}\" tools=\"{tools}\" />\n<div class=\"border-t border-b border-gray-200 flex\">\n    <Segmented style=\"{field_style}\" label=\"Orders Filter\"\n        segments=\"{[{ name : 'Paid', value : 'paid'}, { name : 'All', value : 'all'}]}\" bind:value=\"{$filters.type}\" />\n    <Segmented style=\"{field_style}\" label=\"Display\"\n        segments=\"{[{ name : 'All', value : ''}, { name : 'By Vendor', value : 'true'}]}\" bind:value=\"{show_vendor}\" />\n</div>\n<div class=\"flex text-lg font-semibold m-2\">\n    <button on:click=\"{ () => changeDate(-1) }\"><i class=\"far fa-arrow-alt-circle-left\"></i></button>\n    <div class=\"flex-grow self-center text-center\">\n        {selected_date.format('ddd D/M/YY')}\n    </div>\n    <button on:click=\"{ () => changeDate(1) }\"><i class=\"far fa-arrow-alt-circle-right\"></i></button>\n</div>\n<div class=\"m-2\">\n    <table class=\"w-full\">\n        <tr class=\"bg-theme text-white rounded-lg\">\n            <td>Product</td>\n            <td>Variant</td>\n            <td>Modifiers</td>\n            <td>Quantity</td>\n            <td>Unit Price</td>\n            <td><b>Total</b></td>\n        </tr>\n        {#each Object.keys(vendor_list) as vendor}\n        <tr class=\"bg-gray-600 text-white\">\n            <td>{vendor}</td><td></td><td></td><td></td><td></td><td></td>\n        </tr>\n        {#each filter(vendor) as prod_id}\n        {#each Object.keys(raw_orders[prod_id]) as variant}\n        {#each Object.keys(raw_orders[prod_id][variant]) as mods}\n    <tr>\n        <td>{prodFor(prod_id).name}</td>\n        <td>{variant}</td>\n        <td>{mods}</td>\n        <td>{raw_orders[prod_id][variant][mods].quantity}</td>\n        <td>{raw_orders[prod_id][variant][mods].amount.toFixed(2)}</td>\n        <td>{(raw_orders[prod_id][variant][mods].quantity * raw_orders[prod_id][variant][mods].amount).toFixed(2)}</td>\n    </tr>\n        {/each}\n        {/each}\n        {/each}\n        {/each}\n    </table>\n</div>"],"names":["ctx","name","quantity","amount","toFixed","Object","keys","length","format","value","type","selected_date","dayjs","filters","writable","show_vendor","raw_orders","products","vendors","vendor_list","All Orders","get_orders","pg","$loading","fetch","api","groupBy","order_type","$filters","from","startOf","toJSON","to","endOf","then","data","variants","prodFor","prod_id","find","p","id","toString","filter","vendor","r","includes","changeDate","day","add","subscribe","v","list","forEach","map","icon","function","e","detail","orders","variant","mods","item","fields","Product","Variant","Modifiers","Quantity","Unit Price","Total","Vendor","download","Papa","unparse","container","label"],"mappings":"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"}