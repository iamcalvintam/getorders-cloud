{"version":3,"file":"OrdersMan-e31beacd.js","sources":["../../src/OrdersMan.html"],"sourcesContent":["<svelte:head>\n  <script src=\"https://unpkg.com/papaparse@latest/papaparse.min.js\"></script>\n</svelte:head>\n<script>\n  import { writable, derived, get } from 'svelte/store';\n  import dayjs from \"dayjs\"\n  import Toolbar from './UI/UIToolbar.html';\n  import ActivatePay from './ActivatePay.html';\n  import Inspector from './OrderInspect.html';\n  import OrdersExport from './OrdersExport.html';\n  import { api, fetch, session, modal, settings, loading, download, apply, sub } from './CTStore.js';\n  import UIItem from './UI/UIItem.html'\n  let orders = {}, page = 0, show_more = true, raw_orders = [], subs, pages = [50, 100, 150];\n  let tools = [{ name: \"Refresh\", icon: \"refresh\", function: \"refresh\" },\n  { name: \"Export\", icon: \"cloud-download\", function: \"export\" }]\n  let filters = writable({});\n  filters.subscribe(v => {\n    if (v.sub) {\n      $sub = subs.find(s => s.fire_id == v.sub)\n    }\n    get_orders(0)\n  });\n  get_orders(0);\n  function selected(e) {\n    switch (e.detail.function) {\n      case \"refresh\":\n        get_orders(0)\n        break;\n      case \"export\":\n        {\n          $modal = [...$modal, { view: OrdersExport }];\n        }\n        break;\n    }\n  }\n  apply.subscribe(cb => {\n    if (cb.order) {\n      raw_orders = raw_orders.map(o => {\n        if (o.invoice_id == cb.order.invoice_id) {\n          o = cb.order;\n        }\n        return o;\n      });\n      $apply = {};\n      process_orders();\n    }\n  });\n  function get_orders(pg) {\n    if (pg == 0) {\n      show_more = true;\n    }\n    page = pg;\n    $loading = true;\n    fetch(api(`/orders/${page}`), $filters, 'GET').then(data => {\n      $loading = false;\n      if (data.subs) {\n        subs = data.subs;\n      }\n      if (data.orders.length == 0) {\n        show_more = false;\n      } else {\n        raw_orders = page == 0 ? data.orders : [...raw_orders, ...data.orders]\n        process_orders();\n      }\n    });\n  }\n  function process_orders() {\n    let days = {}\n    //Split orders to days\n    raw_orders.forEach(o => {\n      let day = dayjs(o.createdAt).format('YYYY-MM-DD')\n      days[day] = [...(days[day] || []), o]\n    })\n    orders = days;\n  }\n  function calc(sum, item) {\n    return parseFloat(sum) + parseFloat(item.unit_price) * item.quantity;\n  }\n  function reject(order) {\n    order.status = 4;\n    $loading = true;\n    fetch(api('/orders'), { _id: order._id, status: order.status, sub: $sub.fire_id }, \"PUT\").then(r => {\n      $loading = false;\n      $apply = { order };\n    })\n  }\n  function accept(order) {\n    if ($settings.settings.billplz_token) {\n      $loading = true\n      fetch(api('/payment/billplz'), { order_id: order.invoice_id }, \"GET\").then(r => {\n        raw_orders = raw_orders.map(o => {\n          if (o.invoice_id == order.invoice_id) {\n            o.status = 3;\n            o.payment = { bill_id: r.bill_id, url: r.url };\n          }\n          return o;\n        });\n        process_orders();\n        $loading = false;\n      });\n    } else {\n      $modal = [...$modal, { view: ActivatePay }]\n    }\n  }\n  function message(order) {\n    let phone = order.guest.phone;\n    if (phone.startsWith('01')) phone = \"6\" + phone;\n    let url = `https://api.whatsapp.com/send?phone=${phone}&text=`, msg = \"\";\n    if (order.status == 4) {\n      msg = `Hey, we are contacting from *(${$sub.name || $settings.settings.name})*. Unfortunately we can't serve you at this moment. Please note that your order has been *canceled*.`;\n      msg = `${msg} üëâüèª https://pay.getorders.app/?i=${order.invoice_id}\\n\\n`;\n    } else if (order.status >= 3) {\n      msg = `Hey there! We *(${$sub.name || $settings.settings.name})* have received your order, tap here to pay now.`;\n      msg = `${msg} üëâüèª https://pay.getorders.app/?i=${order.invoice_id}\\n\\n`;\n    }\n    let txt = encodeURIComponent(msg)\n    document.location.href = `${url}${txt}`;\n  }\n  let status_colors = ['bg-gray-400', 'bg-gray-400', 'bg-gray-400', 'bg-yellow-500', 'bg-red-400', 'bg-green-500', 'bg-pink-500', 'bg-theme']\n</script>\n<style>\n  .action {\n    @apply rounded-full text-white mr-3 w-12 h-12 text-center self-center text-2xl flex-none shadow-md;\n  }\n</style>\n<Toolbar class=\"border-b border-gray-300\" on:selected=\"{selected}\" tools=\"{tools}\" />\n{#if subs}\n<div class=\"border-t border-b border-gray-200 flex\">\n  <div class=\"p-2 flex-none\">\n    <label class=\"block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2\">\n      Account\n    </label>\n    <select bind:value=\"{$filters.sub}\">\n      {#each subs as sub}\n      <option value=\"{sub.fire_id}\">{sub.name}</option>\n      {/each}\n    </select>\n  </div>\n  <div class=\"p-2 flex-none\">\n    <label class=\"block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2\">\n      Per Page\n    </label>\n    <select bind:value=\"{$filters.pages}\">\n      {#each pages as page}\n        <option value=\"{page}\">{page}</option>\n        {/each}\n      </select>\n  </div>\n</div>\n{/if}\n  {#each Object.keys(orders) as day}\n  <div class=\"rounded-lg bg-theme text-white text-lg font-semibold m-2 p-2\">\n      {dayjs(day).format('ddd D/M/YY')}\n    </div>\n  {#each orders[day] as order}\n<UIItem>\n  <div on:click=\"{ () => $modal = [...$modal, { view: Inspector, order }] }\" class=\"flex-grow p-2 cursor-pointer { order.status==7 || order.status==4 ? 'opacity-25' : ''}\">\n  <p class=\"text-theme font-semibold\">\n    {dayjs(order.createdAt).format('h:mmA')} \n    {#if $settings.settings}\n    <span class=\"ml-2 rounded-lg {status_colors[order.status]} text-white text-sm px-2 capitalize\">{$settings.settings.statuses[order.status]}</span>\n    {/if}\n  </p>\n  <p class=\"font-semibold leading-tight\">\n    {order.guest.name}\n  </p>\n  <p class=\"leading-tight text-gray-600\">\n    {order.guest.phone}\n  </p>\n  <p class=\"text-sm\">\n    {#if order.guest.address}\n      {order.guest.address}\n      {order.guest.address2}\n    {:else}\n      PICKUP ORDER\n    {/if}\n    </p>\n    {#if order.payment && order.payment.paidAt}\n    <p class=\"text-sm text-green-500 font-semibold\">\n      <i class=\"icon ion-md-checkmark-circle pr-1\"></i> Paid on {dayjs(order.payment.paidAt).format('DD/MM/YYYY h:mmA')}\n    </p>\n    {/if}\n    {#if order.delivery}\n    <p class=\"text-sm text-orange-500 font-semibold\">\n      <i class=\"icon ion-md-cube pr-1\"></i> Delivery requested on {dayjs(order.delivery.createdAt).format('DD/MM/YYYY h:mmA')}\n    </p>\n    {/if}\n  </div>\n    {#if order.status==2}\n    <button on:click=\"{ ()=> accept(order) }\" class=\"action bg-theme\">\n      <i class=\"icon ion-md-checkmark\"></i>\n    </button>\n    <button on:click=\"{ ()=> reject(order) }\" class=\"action bg-theme\">\n      <i class=\"icon ion-md-close\"></i>\n    </button>\n    {/if}\n    <button on:click=\"{ () => message(order) }\" class=\"action bg-theme\">\n      <i class=\"icon ion-logo-whatsapp\"></i>\n    </button>\n</UIItem>\n{/each}\n  {/each}\n  {#if show_more}\n  <div class=\"flex justify-center mt-2\">\n      <button on:click=\"{ () => get_orders(page+1) }\"\n        class=\"p-2 w-1/2 shadow-md bg-theme text-white rounded-lg capitalize font-bold h-full shadow-md\">\n        Show More\n      </button>\n  </div>\n  {/if}"],"names":["ctx","length","sub","pages","name","fire_id","settings","statuses","status","guest","address","address2","dayjs","payment","paidAt","format","delivery","createdAt","phone","Object","keys","subs","orders","page","show_more","raw_orders","filters","writable","get_orders","pg","$loading","fetch","api","$filters","then","data","process_orders","days","forEach","o","day","reject","order","_id","$sub","r","$apply","accept","$settings","billplz_token","order_id","invoice_id","map","bill_id","url","$modal","view","ActivatePay","message","startsWith","msg","txt","encodeURIComponent","document","location","href","subscribe","v","find","s","apply","cb","icon","function","e","detail","OrdersExport","Inspector"],"mappings":"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"}