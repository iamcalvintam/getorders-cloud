{"version":3,"file":"Vouchers-a7c5edf2.js","sources":["../../src/VoucherView.html","../../src/Vouchers.html"],"sourcesContent":["<script>\n    import { onMount, afterUpdate } from 'svelte'\n    import Toolbar from './UI/UIToolbar.html'\n    import TextField from './UI/UITextField.html'\n    import ModalView from './UI/UIModalView.html'\n    import Segmented from './UI/UISegmented.html';\n    import Loading from './UI/UILoading.html'\n    import { writable } from 'svelte/store';\n\n        \n    import { session, api, alert, accounts, modal, apply, fetch, customers, pop_modal, s3 } from './CTStore.js';\n    export let voucher = { code: \"\", discount: 0 };\n    let loading = false;\n    const mode = writable(\"discount\");\n\n    mode.subscribe(value => {\n        switch (value) {\n            case 'discount':\n                voucher = { code: voucher.code, discount: 0 }\n                break;\n            case 'delivery':\n                voucher = { code: voucher.code, delivery: 0, min: 0 }\n                break;\n        } \n    });\n    let style = { body: 'screen-height', content: 'overflow-y-scroll scrolling-touch' }\n    let tool_style = { container: \"justify-end\" }, field_style = { container: 'w-1/2 m-2' };\n    let tools = [{ name: \"Close\", icon: \"close-circle\", function: \"pop_modal\" },\n    { name: \"Save\", icon: \"checkmark-circle\", function: \"save\" }]\n    function selected(e) {\n        if (e.detail.function == 'pop_modal') {\n            pop_modal()\n        }\n        if (e.detail.function == 'save') {\n            loading = true;\n            fetch(api(`/vouchers`), voucher).then(r => { $apply = { voucher: r }; pop_modal(); });\n        }\n    }\n</script>\n<ModalView style=\"{style}\">\n    <div slot=\"loader\">\n        {#if loading}\n  <Loading>\n    <div slot=\"message\">\n      One Moment Please..\n    </div>\n  </Loading>\n    {/if}\n  </div>\n  <div slot=\"title\" class=\"font-semibold text-xl text-gray-600 pb-3\">\n    { voucher._id ? 'Edit Voucher' : 'Create Voucher'}\n  </div>\n  <div slot=\"content\">\n    <div class=\"flex mb-2\">\n        <TextField style=\"{field_style}\" label=\"Code\" placeholder=\"Enter a voucher code\" bind:value=\"{voucher.code}\" />\n    </div>\n    <Segmented style=\"{field_style}\"\n        label=\"Type\"\n        segments=\"{[{ name : 'Discount', value : 'discount'}, { name : 'Delivery', value : 'delivery'}]}\"\n        bind:value=\"{$mode}\" />\n    <div class=\"flex mb-2\">\n        {#if $mode==\"discount\"}\n        <TextField style=\"{field_style}\" label=\"Discount (%)\" placeholder=\"e.g : 10\" bind:value=\"{voucher.discount}\" />\n        {:else if $mode==\"delivery\"}\n        <TextField style=\"{field_style}\" label=\"Delivery Subsidy (RM)\" placeholder=\"e.g : 0\" bind:value=\"{voucher.delivery}\" />\n        <TextField style=\"{field_style}\" label=\"Min. Spending (RM)\" placeholder=\"e.g : 0\" bind:value=\"{voucher.min}\" />\n        {/if}\n    </div>\n  </div>\n<div slot=\"toolbar\">\n    <Toolbar on:selected=\"{selected}\" tools=\"{tools}\" style=\"{tool_style}\" />\n  </div>\n</ModalView>","<script>\n    import { onMount } from 'svelte';\n    import Toolbar from './UI/UIToolbar.html';\n    import Loading from './UI/UILoading.html';\n    import UIItem from './UI/UIItem.html';\n    import VoucherView from './VoucherView.html';\n    import { session, api, alert, accounts, apply, modal, fetch } from './CTStore.js';\n    let vouchers, loading = false, redeem_count = {};\n    let style = { container: \"border-b border-gray-300\" }\n    let tools = [{ name: \"Create\", icon: \"add\", function: \"add\" }]\n    onMount(async() => {\n        vouchers = await fetch(api('/vouchers'));\n        vouchers.forEach(v => {\n            fetch(api(`/vouchers/${v._id}`)).then(c => {\n                redeem_count[v._id] = c;\n            })\n        })\n    });\n    apply.subscribe(cb => {\n        if (cb.voucher) {\n            let obj = vouchers.find(p => p._id == cb.voucher._id)\n            if (obj) {\n                vouchers = vouchers.map(p => p._id == cb.voucher._id ? cb.voucher : p)\n            } else {\n                vouchers = [...vouchers, cb.voucher]\n            }\n            $apply = {};\n        }\n    });\n    function inspect(product) {\n        $modal = [...$modal, { product, view: ProductView }]\n    }\n    function selected(e) {\n        if (e.detail.function == 'add') {\n            $modal = [...$modal, { view: VoucherView }]\n        }\n    }\n    function remove(voucher){\n        if(confirm(`Do you really want to remove this voucher (${voucher.code})?`)){\n            loading = true;\n            fetch(api(`/vouchers`), { _id : voucher._id, deletedAt : Date() }, \"PUT\").then(r => { loading = false; $apply = { voucher: {...voucher, deletedAt: Date()} } });\n        }\n    }\n</script>\n<style>\n    .sect {\n        @apply text-xl font-bold mt-3 mx-2;\n    }\n\n    table {\n        @apply w-full;\n    }\n\n    td {\n        @apply p-2;\n    }\n</style>\n<Toolbar style=\"{style}\" on:selected=\"{selected}\" tools=\"{tools}\" />\n{#if !vouchers || loading}\n<Loading type=\"h-64\">\n    <div slot=\"message\">\n      One Moment Please..\n    </div>\n  </Loading>\n{:else}\n<table class=\"my-2\">\n    <tr class=\"font-semibold text-theme text-sm text-center\">\n        <td>Voucher Code</td>\n        <td>Type</td>\n        <td>Redemptions</td>\n        <td></td>\n    </tr>\n{#each vouchers as voucher}\n    <tr class=\"text-center hover:bg-gray-200 { voucher.deletedAt ? 'opacity-25 line-through' : ''}\">\n        <td class=\"text-gray-800 text-left\">{voucher.code}</td>\n        <td>\n            {#if voucher.delivery}\n            <p>\n                Discount on delivery up to <b>RM{voucher.delivery.toFixed(2)}</b>\n            </p>\n            {/if}\n            {#if voucher.discount}\n            <p>\n                <b>{voucher.discount}%</b> discount on entire cart\n            </p>\n            {/if}\n            {#if voucher.min}\n            <p>\n                Minimum spending of <b>RM{voucher.min.toFixed(2)}</b> required\n            </p>\n            {/if}\n        </td>\n        <td>\n            {#if redeem_count[voucher._id] != undefined}\n                {redeem_count[voucher._id]}\n            {:else}\n                <i class=\"fas fa-spinner fa-spin\"></i>\n            {/if}\n        </td>\n        <td>\n            {#if !voucher.deletedAt}\n            <button class=\"p-2\" on:click=\"{ () => remove(voucher) }\">\n                <i class=\"fas fa-trash\"></i>\n            </button>\n            {/if}\n        </td>\n    </tr>\n{/each}\n</table>\n{/if}"],"names":["ctx","_id","delivery","min","discount","code","name","value","voucher","loading","mode","writable","subscribe","body","content","container","icon","function","e","detail","pop_modal","fetch","api","then","r","$apply","$mode","length","toFixed","undefined","deletedAt","vouchers","redeem_count","remove","confirm","Date","onMount","forEach","v","c","apply","cb","obj","find","p","map","$modal","view","VoucherView","product","ProductView"],"mappings":"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"}