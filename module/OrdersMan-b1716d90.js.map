{"version":3,"file":"OrdersMan-b1716d90.js","sources":["../../src/ActivatePay.html","../../src/OrdersMan.html"],"sourcesContent":["<script>\n    import { onMount, afterUpdate } from 'svelte'\n    import ModalView from './UI/UIModalView.html'\n    import { support, api, settings, accounts, modal, pop_modal } from './CTStore.js';\n    function contact() {\n        support(`Hello, I would like to activate payments for my GetOrders account.\\n üëâüèª My ID : ${$settings.settings.fire_id}`);\n    }\n</script>\n<ModalView>\n    <div slot=\"title\" class=\"font-semibold text-xl text-gray-600 pb-3\">\n        Activate GetPayments\n    </div>\n    <div slot=\"content\" class=\"h-64 p-2\">\n        <p class=\"text-gray-800 mb-6 text-center\">\n            In order to accept payments, your account has to first activate <b>GetPayments</b>.<br>\n            Tap here to contact our support to activate now.\n        </p>\n        <div class=\"flex justify-center mt-2\">\n            <button on:click=\"{contact}\"\n                class=\"p-2 w-1/2 shadow-md bg-theme text-white rounded-lg capitalize font-bold h-full shadow-md\">\n                Contact Support\n            </button>\n        </div>\n        <div class=\"flex justify-center mt-2\">\n            <button on:click=\"{pop_modal}\"\n                class=\"p-2 w-1/2 shadow-md bg-gray-400 text-white rounded-lg capitalize font-bold h-full shadow-md\">\n                Cancel\n            </button>\n        </div>\n    </div>\n</ModalView>","<svelte:head>\n  <script src=\"https://unpkg.com/papaparse@latest/papaparse.min.js\"></script>\n</svelte:head>\n<script>\n  import dayjs from \"dayjs\"\n  import Toolbar from './UI/UIToolbar.html';\n  import ActivatePay from './ActivatePay.html'\n  import { api, headers, session, modal, settings, loading, download } from './CTStore.js';\n  import UIItem from './UI/UIItem.html'\n  let orders = {}, page = 0, show_more = true, raw_orders = [];\n  let tools = [{ name: \"Refresh\", icon: \"refresh\", function: \"refresh\" },\n  { name: \"Export\", icon: \"cloud-download\", function: \"export\" }]\n  get_orders(0);\n  function selected(e) {\n    switch (e.detail.function) {\n      case \"refresh\":\n        get_orders(0)\n        break;\n      case \"export\":\n        {\n          let orders = [];\n          raw_orders.forEach(r => {\n            if (r.payment) {\n              let fields = {\n                \"order_date\": dayjs(r.createdAt).format('MM/DD h:mmA'),\n                \"name\": r.guest.name,\n                \"phone\": r.guest.phone,\n                \"address\": `${r.guest.address || ''} ${r.guest.address2 || ''}`,\n                \"isPickUp\": r.guest.address ? 'N' : 'Y',\n                \"amount\": r.payment.amount.toFixed(2),\n                \"paid\": r.payment.paidAt ? dayjs(r.payment.paidAt).format('MM/DD h:mmA') : '',\n                \"invoice\": `https://pay.getorders.app/?i=${r.invoice_id}`\n              }\n              orders = [...orders, fields];\n            }\n          })\n          download(Papa.unparse(orders), 'orders.csv', 'text/csv;encoding:utf-8');\n        }\n        break;\n    }\n  }\n  function get_orders(pg) {\n    if (pg == 0) {\n      show_more = true;\n    }\n    page = pg;\n    $loading = true;\n    fetch(api(`/orders/${page}`), headers()).then(r => r.json()).then(data => {\n      $loading = false;\n      if (data.orders.length == 0) {\n        show_more = false;\n      } else {\n        raw_orders = page == 0 ? data.orders : [...raw_orders, ...data.orders]\n        process_orders();\n      }\n    });\n  }\n  function process_orders() {\n    let days = {}\n    //Split orders to days\n    raw_orders.forEach(o => {\n      let day = dayjs(o.createdAt).format('YYYY-MM-DD')\n      days[day] = [...(days[day] || []), o]\n    })\n    orders = days;\n  }\n  function calc(sum, item) {\n    return parseFloat(sum) + parseFloat(item.unit_price) * item.quantity;\n  }\n  function accept(order) {\n    if ($settings.settings.billplz_token) {\n      $loading = true\n      let headers = {\n        'order_id': order.invoice_id,\n        'Accept': 'application/json',\n        'Content-Type': 'application/json',\n        'x-api-key': 'EF95vGTnuo1GDqSQw6BmN41IR1G5R0Li8E5WIxlm'\n      };\n      fetch('https://api.getorders.app/payment/billplz', { method: \"GET\", headers }).then(r => r.json()).then(r => {\n        raw_orders = raw_orders.map(o => {\n          if (o.invoice_id == order.invoice_id) {\n            o.payment = { bill_id: r.bill_id, url: r.url };\n          }\n          return o;\n        });\n        process_orders();\n        $loading = false;\n      });\n    } else {\n      $modal = [...$modal, { view: ActivatePay }]\n    }\n  }\n  function message(order) {\n    let phone = order.guest.phone;\n    if (phone.startsWith('01')) phone = \"6\" + phone;\n    let url = `https://api.whatsapp.com/send?phone=${phone}&text=`, msg = \"\";\n    if (order.payment) {\n      msg = `Hey there! We *(${$settings.settings.name})* have received your order, tap here to pay now.`;\n      msg = `${msg} üëâüèª https://pay.getorders.app/?i=${order.invoice_id}\\n\\n`;\n    }\n    let txt = encodeURIComponent(msg)\n    document.location.href = `${url}${txt}`;\n  }\n</script>\n<style>\n  .action {\n    @apply rounded-full text-white mr-3 w-16 h-16 text-center self-center text-2xl flex-none shadow-md;\n  }\n</style>\n<Toolbar class=\"border-b border-gray-300\" on:selected=\"{selected}\" tools=\"{tools}\" />\n{#each Object.keys(orders) as day}\n  <div class=\"rounded-lg bg-theme text-white text-lg font-semibold m-2 p-2\">\n      {dayjs(day).format('ddd D/M/YY')}\n    </div>\n  {#each orders[day] as order}\n<UIItem>\n  <a href=\"{`https://pay.getorders.app/?i=${order.invoice_id}`}\" target=\"_blank\" class=\"flex-grow p-2\">\n  <p class=\"text-theme font-semibold\">\n    {dayjs(order.createdAt).format('h:mmA')}\n  </p>\n  <p class=\"font-semibold leading-tight\">\n    {order.guest.name}\n  </p>\n  <p class=\"leading-tight text-gray-600\">\n    {order.guest.phone}\n  </p>\n  <p class=\"text-sm\">\n    {#if order.guest.address}\n      {order.guest.address}\n      {order.guest.address2}\n    {:else}\n      PICKUP ORDER\n    {/if}\n    </p>\n    {#if order.payment && order.payment.paidAt}\n    <p class=\"text-sm text-green-400 font-semibold\">\n      <i class=\"icon ion-md-checkmark-circle pr-1\"></i> Paid on {dayjs(order.payment.paidAt).format('DD/MM/YYYY h:mmA')}\n    </p>\n    {/if}\n  </a>\n    {#if !order.payment}\n    <button on:click=\"{ ()=> accept(order) }\" class=\"action bg-theme\">\n      <i class=\"icon ion-md-checkmark-circle-outline\"></i>\n    </button>\n    {/if}\n    <button on:click=\"{ () => message(order) }\" class=\"action bg-theme\">\n      <i class=\"icon ion-logo-whatsapp\"></i>\n    </button>\n</UIItem>\n{/each}\n  {/each}\n  {#if show_more}\n  <div class=\"flex justify-center mt-2\">\n      <button on:click=\"{ () => get_orders(page+1) }\"\n        class=\"p-2 w-1/2 shadow-md bg-theme text-white rounded-lg capitalize font-bold h-full shadow-md\">\n        Show More\n      </button>\n  </div>\n  {/if}"],"names":["ctx","pop_modal","support","$settings","settings","fire_id","guest","address","address2","dayjs","payment","paidAt","format","createdAt","name","phone","invoice_id","length","Object","keys","orders","page","show_more","raw_orders","get_orders","pg","$loading","fetch","api","headers","then","r","json","data","process_orders","days","forEach","o","day","accept","order","billplz_token","order_id","Accept","Content-Type","x-api-key","method","map","bill_id","url","$modal","view","ActivatePay","message","startsWith","msg","txt","encodeURIComponent","document","location","href","icon","function","e","detail","fields","order_date","isPickUp","amount","toFixed","paid","invoice","download","Papa","unparse"],"mappings":"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"}